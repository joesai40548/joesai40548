<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="JoeSai - AI Assistant powered by Groq API. Intelligent chat with natural language responses.">
  <meta name="keywords" content="AI, chatbot, Groq, artificial intelligence, JoeSai, machine learning">
  <meta name="author" content="JoeSai">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#7c3aed">
  
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="JoeSai - AI Assistant">
  <meta property="og:description" content="Intelligent AI Assistant powered by Groq API">
  
  <title>JoeSai - AI Assistant</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .chat-gradient {
      background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    .message-enter {
      animation: messageEnter 0.3s ease-out;
    }
    @keyframes messageEnter {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .typing-indicator span {
      animation: typing 1.4s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <div id="app" class="relative min-h-screen">
    
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <!-- Logo -->
        <div class="flex items-center space-x-2">
          <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          </div>
          <span class="text-2xl font-bold text-white">JoeSai</span>
        </div>
        
        <!-- Auth Buttons / User Menu -->
        <div id="auth-section" class="flex items-center space-x-3">
          <!-- Guest View -->
          <div id="guest-buttons" class="flex items-center space-x-2">
            <button id="login-btn" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-all font-medium">
              Login
            </button>
            <button id="register-btn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white rounded-lg transition-all font-medium shadow-lg">
              Sign Up
            </button>
          </div>
          
          <!-- Logged In View -->
          <div id="user-menu" class="hidden flex items-center space-x-3">
            <!-- Upgrade Button (for non-admin users) -->
            <button id="upgrade-btn" class="px-3 py-1 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white rounded-lg text-sm font-medium hidden" title="Upgrade to Premium">
              âš¡ Upgrade
            </button>
            <!-- Admin Dashboard Button -->
            <button id="admin-dashboard-btn" class="px-3 py-1 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-lg text-sm font-medium hidden" title="Admin Dashboard">
              ðŸ‘‘ Admin
            </button>
            <div class="flex items-center space-x-2">
              <img id="user-avatar" src="" alt="Avatar" class="w-8 h-8 rounded-full border-2 border-purple-400">
              <span id="user-name" class="text-white font-medium hidden md:inline"></span>
            </div>
            <button id="settings-btn" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Settings">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </button>
            <button id="logout-btn" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Logout">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
      <!-- Chat Interface -->
      <div class="max-w-4xl mx-auto">
        <div class="chat-gradient rounded-2xl shadow-2xl overflow-hidden min-h-[70vh] flex flex-col">
          <!-- Chat Header -->
          <div class="p-4 border-b border-white/10 flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
              </div>
              <div>
                <h2 class="text-white font-bold">JoeSai</h2>
                <p class="text-purple-300 text-sm">AI Assistant</p>
              </div>
            </div>
            <button id="clear-chat-btn" class="text-white/60 hover:text-white text-sm flex items-center space-x-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              <span>Clear</span>
            </button>
          </div>
          
          <!-- Messages Container -->
          <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Welcome Message -->
            <div class="flex justify-center py-8">
              <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                </div>
                <h3 class="text-white text-xl font-bold mb-2">Welcome to JoeSai!</h3>
                <p class="text-purple-300">Your intelligent AI assistant powered by Groq API</p>
                <p id="login-prompt-header" class="text-white/60 text-sm mt-4">Please login or sign up to save your chat history</p>
              </div>
            </div>
          </div>
          
          <!-- Input Area -->
          <div class="p-4 border-t border-white/10">
            <div class="flex items-end space-x-2">
              <div class="flex-1 relative">
                <textarea 
                  id="message-input" 
                  placeholder="Type your message..." 
                  rows="1"
                  class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:border-purple-500 resize-none"
                ></textarea>
              </div>
              <button id="send-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white p-3 rounded-xl transition-all shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeLoginModal()"></div>
      <div class="relative flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
          <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <h2 class="text-2xl font-bold text-white mb-6 text-center">Welcome Back</h2>
          
          <!-- Google Login -->
          <button id="google-login-btn" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-medium py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors mb-4">
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>Continue with Google</span>
          </button>
          
          <div class="relative my-4">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-gray-700"></div>
            </div>
            <div class="relative flex justify-center text-sm">
              <span class="px-2 bg-gray-900 text-gray-400">or</span>
            </div>
          </div>
          
          <!-- Email Login Form -->
          <form id="email-login-form" class="space-y-4">
            <div>
              <label class="block text-gray-300 text-sm font-medium mb-2">Email</label>
              <input type="email" id="login-email" required class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500">
            </div>
            <div>
              <label class="block text-gray-300 text-sm font-medium mb-2">Password</label>
              <input type="password" id="login-password" required class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500">
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-medium py-3 rounded-xl transition-all">
              Login
            </button>
          </form>
          
          <p class="text-center text-gray-400 mt-4">
            Don't have an account? 
            <button onclick="switchToRegister()" class="text-purple-400 hover:text-purple-300">Sign up</button>
          </p>
          <div class="mt-4 pt-4 border-t border-gray-700 flex justify-center space-x-4 text-sm">
            <button onclick="openPrivacyModal()" class="text-gray-400 hover:text-purple-400">Privacy Policy</button>
            <span class="text-gray-600">|</span>
            <button onclick="openTermsModal()" class="text-gray-400 hover:text-purple-400">Terms of Service</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeRegisterModal()"></div>
      <div class="relative flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
          <button onclick="closeRegisterModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <h2 class="text-2xl font-bold text-white mb-6 text-center">Create Account</h2>
          
          <!-- Google Register -->
          <button id="google-register-btn" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-medium py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors mb-4">
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>Sign up with Google</span>
          </button>
          
          <div class="relative my-4">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-gray-700"></div>
            </div>
            <div class="relative flex justify-center text-sm">
              <span class="px-2 bg-gray-900 text-gray-400">or</span>
            </div>
          </div>
          
          <!-- Email Register Form -->
          <form id="email-register-form" class="space-y-4">
            <div>
              <label class="block text-gray-300 text-sm font-medium mb-2">Name</label>
              <input type="text" id="register-name" required class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500">
            </div>
            <div>
              <label class="block text-gray-300 text-sm font-medium mb-2">Email</label>
              <input type="email" id="register-email" required class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500">
            </div>
            <div>
              <label class="block text-gray-300 text-sm font-medium mb-2">Password</label>
              <input type="password" id="register-password" required minlength="6" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500">
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-medium py-3 rounded-xl transition-all">
              Create Account
            </button>
          </form>
          
          <p class="text-center text-gray-400 mt-4">
            Already have an account? 
            <button onclick="switchToLogin()" class="text-purple-400 hover:text-purple-300">Login</button>
          </p>
          <div class="mt-4 pt-4 border-t border-gray-700 flex justify-center space-x-4 text-sm">
            <button onclick="openPrivacyModal()" class="text-gray-400 hover:text-purple-400">Privacy Policy</button>
            <span class="text-gray-600">|</span>
            <button onclick="openTermsModal()" class="text-gray-400 hover:text-purple-400">Terms of Service</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSettingsModal()"></div>
      <div class="relative flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-lg p-6 relative max-h-[80vh] overflow-y-auto">
          <button onclick="closeSettingsModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <h2 class="text-2xl font-bold text-white mb-6">Settings</h2>
          
          <!-- Profile Section -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-3">Profile</h3>
            <div class="bg-gray-800 rounded-xl p-4">
              <div class="flex items-center space-x-4 mb-4">
                <img id="settings-avatar" src="" alt="Avatar" class="w-16 h-16 rounded-full border-2 border-purple-500">
                <div>
                  <p id="settings-name" class="text-white font-medium"></p>
                  <p id="settings-email" class="text-gray-400 text-sm"></p>
                </div>
              </div>
              <button id="change-avatar-btn" class="text-purple-400 hover:text-purple-300 text-sm">Change Avatar</button>
            </div>
          </div>
          
          <!-- Chat Settings -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-3">Chat Settings</h3>
            <div class="space-y-3">
              <label class="flex items-center justify-between bg-gray-800 rounded-xl p-4 cursor-pointer">
                <span class="text-gray-300">Save chat history</span>
                <input type="checkbox" id="save-history-toggle" checked class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
              </label>
              <label class="flex items-center justify-between bg-gray-800 rounded-xl p-4 cursor-pointer">
                <span class="text-gray-300">Show typing indicator</span>
                <input type="checkbox" id="typing-toggle" checked class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
              </label>
              <label class="flex items-center justify-between bg-gray-800 rounded-xl p-4 cursor-pointer">
                <span class="text-gray-300">Sound notifications</span>
                <input type="checkbox" id="sound-toggle" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
              </label>
            </div>
          </div>
          
          <!-- AI Settings -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-3">AI Settings</h3>
            <div class="space-y-3">
              <div class="bg-gray-800 rounded-xl p-4">
                <label class="block text-gray-300 text-sm mb-2">Response Creativity</label>
                <input type="range" id="creativity-slider" min="0" max="1" step="0.1" value="0.7" class="w-full">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>Precise</span>
                  <span>Creative</span>
                </div>
              </div>
              <div class="bg-gray-800 rounded-xl p-4">
                <label class="block text-gray-300 text-sm mb-2">Max Response Length</label>
                <select id="max-tokens-select" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:border-purple-500">
                  <option value="500">Short (500 tokens)</option>
                  <option value="1000" selected>Medium (1000 tokens)</option>
                  <option value="2000">Long (2000 tokens)</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Data Management -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-3">Data Management</h3>
            <div class="space-y-2">
              <button id="export-history-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                <span>Export Chat History</span>
              </button>
              <button id="delete-history-btn" class="w-full bg-red-900/50 hover:bg-red-900 text-red-300 py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                <span>Delete All History</span>
              </button>
            </div>
          </div>
          
          <!-- Account Settings -->
          <div>
            <h3 class="text-lg font-semibold text-white mb-3">Account</h3>
            <button id="delete-account-btn" class="w-full bg-red-900/50 hover:bg-red-900 text-red-300 py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <span>Delete Account</span>
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBZLoJZVVCVAWafhd4Oh8bhEGV4waN1B5g",
      authDomain: "studypedia-app.firebaseapp.com",
      projectId: "studypedia-app",
      storageBucket: "studypedia-app.firebasestorage.app",
      messagingSenderId: "793261754970",
      appId: "1:793261754970:web:49bbd2bea1ab4d46486663",
      measurementId: "G-6CTGP0MF8Y"
    };

    // Initialize Firebase
    let app, auth, db, googleProvider;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      googleProvider = new GoogleAuthProvider();
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization error:', error);
      alert('Error initializing the app. Please refresh the page and try again.');
    }

    // Groq API Config - Use Vite environment variable
    const GROQ_API_KEY = import.meta.env.VITE_GROQ_API_KEY;
    const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
    
    // Validate API key is configured
    if (!GROQ_API_KEY) {
      console.warn('Groq API key not configured. Please set VITE_GROQ_API_KEY in your .env file.');
    }
    
    // Check if Firebase initialized properly
    if (!auth || !db) {
      console.error('Firebase services not initialized');
    }

    // Global State
    let currentUser = null;
    let chatHistory = [];
    let settings = {
      saveHistory: true,
      showTyping: true,
      soundNotifications: false,
      creativity: 0.7,
      maxTokens: 1000
    };

    // AI System Prompt
    const AI_CONTEXT = `You are JoeSai, an expert AI assistant with extensive knowledge in programming, software development, and technology. 
    
    You are helpful, precise, and consistent in your responses. When providing code:
    - Use proper syntax highlighting with markdown code blocks
    - Include comments explaining the code
    - Provide complete, working examples when possible
    - Explain the logic step by step
    
    You can help with:
    - Programming languages: JavaScript, Python, HTML, CSS, TypeScript, Java, C++, and more
    - Frameworks: React, Vue, Angular, Node.js, Django, Flask, etc.
    - Databases: SQL, MongoDB, Firebase, etc.
    - General tech questions, debugging, and best practices
    
    Respond in a clear, concise, and friendly manner. Use markdown formatting appropriately. For code, use triple backticks with the language name.`;

    // DOM Elements
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const guestButtons = document.getElementById('guest-buttons');
    const userMenu = document.getElementById('user-menu');
    const userAvatar = document.getElementById('user-avatar');
    const userName = document.getElementById('user-name');
    const loginPrompt = document.getElementById('login-prompt');

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadChatHistory();
      loadSettings();
      setupEventListeners();
      checkAuthState();
    });

    // Event Listeners
    function setupEventListeners() {
      // Send message
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auth buttons
      const loginBtn = document.getElementById('login-btn');
      const registerBtn = document.getElementById('register-btn');
      const logoutBtn = document.getElementById('logout-btn');
      
      if (loginBtn) loginBtn.addEventListener('click', openLoginModal);
      if (registerBtn) registerBtn.addEventListener('click', openRegisterModal);
      if (logoutBtn) logoutBtn.addEventListener('click', logout);
      
      // Google auth
      const googleLoginBtn = document.getElementById('google-login-btn');
      const googleRegisterBtn = document.getElementById('google-register-btn');
      
      if (googleLoginBtn) googleLoginBtn.addEventListener('click', () => signInWithGoogle('login'));
      if (googleRegisterBtn) googleRegisterBtn.addEventListener('click', () => signInWithGoogle('register'));
      
      // Email auth forms
      const emailLoginForm = document.getElementById('email-login-form');
      const emailRegisterForm = document.getElementById('email-register-form');
      
      if (emailLoginForm) emailLoginForm.addEventListener('submit', handleEmailLogin);
      if (emailRegisterForm) emailRegisterForm.addEventListener('submit', handleEmailRegister);
      
      // Settings
      document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
      document.getElementById('clear-chat-btn').addEventListener('click', clearChat);
      
      // Upgrade button
      document.getElementById('upgrade-btn').addEventListener('click', openUpgradeModal);
      document.getElementById('upgrade-form').addEventListener('submit', handleUpgradeSubmit);
      
      // Admin dashboard button
      document.getElementById('admin-dashboard-btn').addEventListener('click', openAdminModal);
      
      // Settings toggles
      document.getElementById('save-history-toggle').addEventListener('change', (e) => {
        settings.saveHistory = e.target.checked;
        saveSettings();
      });
      document.getElementById('typing-toggle').addEventListener('change', (e) => {
        settings.showTyping = e.target.checked;
        saveSettings();
      });
      document.getElementById('sound-toggle').addEventListener('change', (e) => {
        settings.soundNotifications = e.target.checked;
        saveSettings();
      });
      document.getElementById('creativity-slider').addEventListener('change', (e) => {
        settings.creativity = parseFloat(e.target.value);
        saveSettings();
      });
      document.getElementById('max-tokens-select').addEventListener('change', (e) => {
        settings.maxTokens = parseInt(e.target.value);
        saveSettings();
      });

      // Data management
      document.getElementById('export-history-btn').addEventListener('click', exportChatHistory);
      document.getElementById('delete-history-btn').addEventListener('click', deleteAllHistory);
      document.getElementById('delete-account-btn').addEventListener('click', deleteAccount);
    }

    // Auth State Observer
    function checkAuthState() {
      if (!auth) {
        console.error('Auth not initialized');
        return;
      }
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          updateUIForLoggedInUser(user);
          await loadUserData(user.uid);
        } else {
          currentUser = null;
          updateUIForGuest();
        }
      });
    }

    // UI Updates
    function updateUIForLoggedInUser(user) {
      guestButtons.classList.add('hidden');
      userMenu.classList.remove('hidden');
      loginPrompt.classList.add('hidden');
      
      const loginPromptHeader = document.getElementById('login-prompt-header');
      if (loginPromptHeader) loginPromptHeader.classList.add('hidden');
      
      const displayName = user.displayName || user.email.split('@')[0];
      const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=7c3aed&color=fff`;
      
      userAvatar.src = photoURL;
      userName.textContent = displayName;
      
      // Show upgrade button for non-admin users
      const upgradeBtn = document.getElementById('upgrade-btn');
      const adminBtn = document.getElementById('admin-dashboard-btn');
      
      // Check if user is admin (from Firestore or hardcoded)
      const isAdmin = user.email === 'kaigwaakram123@gmail.com' || user.email === 'admin@joesai.com';
      
      if (isAdmin) {
        // Admin user - show admin button, hide upgrade
        adminBtn.classList.remove('hidden');
        upgradeBtn.classList.add('hidden');
      } else {
        // Regular user - show upgrade button, hide admin
        adminBtn.classList.add('hidden');
        upgradeBtn.classList.remove('hidden');
      }
    }

    function updateUIForGuest() {
      guestButtons.classList.remove('hidden');
      userMenu.classList.add('hidden');
      loginPrompt.classList.remove('hidden');
      
      const loginPromptHeader = document.getElementById('login-prompt-header');
      if (loginPromptHeader) loginPromptHeader.classList.remove('hidden');
      
      userAvatar.src = '';
      userName.textContent = '';
    }

    // Auth Functions
    async function signInWithGoogle(mode) {
      try {
        // Show loading feedback
        const btn = document.activeElement;
        if (btn && btn.tagName === 'BUTTON') {
          btn.textContent = 'Please wait...';
          btn.disabled = true;
        }
        
        // Configure Google provider
        googleProvider.setCustomParameters({
          prompt: 'select_account'
        });
        
        const result = await signInWithPopup(auth, googleProvider);
        console.log('Google sign in successful:', result.user);
        
        // Check if this is an admin email
        const isAdmin = result.user.email === 'kaigwaakram123@gmail.com' || result.user.email === 'admin@joesai.com';
        
        // Create or update user document
        await setDoc(doc(db, 'users', result.user.uid), {
          uid: result.user.uid,
          email: result.user.email,
          displayName: result.user.displayName,
          photoURL: result.user.photoURL,
          provider: 'google',
          isAdmin: isAdmin,
          createdAt: new Date(),
          lastLogin: new Date()
        }, { merge: true });
        
        console.log('User admin status:', isAdmin);
        
        // Close modals
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('register-modal').classList.add('hidden');
        
        alert('Successfully signed in with Google!');
      } catch (error) {
        console.error('Google sign in error:', error);
        
        // Handle specific errors
        let errorMessage = '';
        switch (error.code) {
          case 'auth/popup-closed-by-user':
            errorMessage = 'Sign-in popup was closed. Please try again.';
            break;
          case 'auth/unauthorized-domain':
            errorMessage = 'This domain is not authorized for Google sign-in.\n\nPlease follow these steps:\n1. Go to Firebase Console â†’ Authentication â†’ Sign-in method\n2. Enable Google sign-in\n3. Add your domain to authorized domains';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Google sign-in is not enabled. Please contact the administrator.';
            break;
          case 'auth/domain-not-configured':
            errorMessage = 'Domain not configured for Google sign-in.';
            break;
          case 'auth/cancelled-popup-request':
            errorMessage = 'Only one popup can be open at a time.';
            break;
          default:
            errorMessage = 'Error signing in: ' + error.message;
        }
        alert(errorMessage);
      }
    }

    async function handleEmailLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      
      // Validate inputs
      if (!email || !password) {
        alert('Please enter both email and password');
        return;
      }
      
      // Show loading state
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Logging in...';
      submitBtn.disabled = true;
      
      try {
        const result = await signInWithEmailAndPassword(auth, email, password);
        console.log('Email login successful:', result.user);
        
        // Update last login
        await updateDoc(doc(db, 'users', result.user.uid), {
          lastLogin: new Date()
        });
        
        // Clear form
        document.getElementById('email-login-form').reset();
        closeLoginModal();
        alert('Successfully logged in!');
      } catch (error) {
        console.error('Email login error:', error);
        
        // Handle specific Firebase auth errors
        let errorMessage;
        switch (error.code) {
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address format.';
            break;
          case 'auth/user-disabled':
            errorMessage = 'This account has been disabled.';
            break;
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email. Please sign up first.';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Incorrect password. Please try again.';
            break;
          case 'auth/invalid-credential':
            errorMessage = 'Invalid email or password.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many failed attempts. Please try again later.';
            break;
          default:
            errorMessage = 'Error logging in: ' + error.message;
        }
        alert(errorMessage);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    async function handleEmailRegister(e) {
      e.preventDefault();
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      
      // Validate inputs
      if (!name || !email || !password) {
        alert('Please fill in all fields');
        return;
      }
      
      if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
      }
      
      // Show loading state
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Creating account...';
      submitBtn.disabled = true;
      
      try {
        const result = await createUserWithEmailAndPassword(auth, email, password);
        
        // Update profile
        await updateProfile(result.user, { displayName: name });
        
        // Check if this is an admin email
        const isAdmin = email === 'kaigwaakram123@gmail.com' || email === 'admin@joesai.com';
        
        // Create user document
        await setDoc(doc(db, 'users', result.user.uid), {
          uid: result.user.uid,
          email: result.user.email,
          displayName: name,
          photoURL: null,
          provider: 'email',
          isAdmin: isAdmin,
          createdAt: new Date(),
          lastLogin: new Date()
        });
        
        console.log('Registration successful:', result.user, 'Admin:', isAdmin);
        
        // Clear form
        document.getElementById('email-register-form').reset();
        closeRegisterModal();
        alert('Account created successfully! Welcome to JoeSai.');
      } catch (error) {
        console.error('Registration error:', error);
        
        // Handle specific Firebase auth errors
        let errorMessage;
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'An account with this email already exists. Please login instead.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address format.';
            break;
          case 'auth/weak-password':
            errorMessage = 'Password is too weak. Please use a stronger password.';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Email/password authentication is not enabled. Please contact the administrator.';
            break;
          default:
            errorMessage = 'Error registering: ' + error.message;
        }
        alert(errorMessage);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    async function logout() {
      try {
        await signOut(auth);
        console.log('Logout successful');
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error logging out: ' + error.message);
      }
    }

    // User Data
    async function loadUserData(uid) {
      if (!db) {
        console.error('Firestore not initialized');
        return;
      }
      
      try {
        const userDoc = await getDoc(doc(db, 'users', uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.settings) {
            settings = { ...settings, ...userData.settings };
            applySettings();
          }
          if (userData.chatHistory) {
            chatHistory = userData.chatHistory;
            renderChatHistory();
          }
          
          // Check for admin status and update UI
          if (userData.isAdmin) {
            updateAdminUI(true);
          }
        }
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }

    // Update admin UI elements
    function updateAdminUI(isAdmin) {
      const upgradeBtn = document.getElementById('upgrade-btn');
      const adminBtn = document.getElementById('admin-dashboard-btn');
      
      if (isAdmin) {
        adminBtn.classList.remove('hidden');
        upgradeBtn.classList.add('hidden');
      } else {
        adminBtn.classList.add('hidden');
        upgradeBtn.classList.remove('hidden');
      }
    }

    async function saveUserData() {
      if (!currentUser || !db) return;
      try {
        await updateDoc(doc(db, 'users', currentUser.uid), {
          settings: settings,
          chatHistory: settings.saveHistory ? chatHistory : []
        });
      } catch (error) {
        console.error('Error saving user data:', error);
      }
    }

    // Settings
    function loadSettings() {
      const saved = localStorage.getItem('joesai_settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
        applySettings();
      }
    }

    function saveSettings() {
      localStorage.setItem('joesai_settings', JSON.stringify(settings));
      if (currentUser) {
        saveUserData();
      }
    }

    function applySettings() {
      document.getElementById('save-history-toggle').checked = settings.saveHistory;
      document.getElementById('typing-toggle').checked = settings.showTyping;
      document.getElementById('sound-toggle').checked = settings.soundNotifications;
      document.getElementById('creativity-slider').value = settings.creativity;
      document.getElementById('max-tokens-select').value = settings.maxTokens;
    }

    // Chat Functions
    function loadChatHistory() {
      const saved = localStorage.getItem('joesai_chat_history');
      if (saved) {
        chatHistory = JSON.parse(saved);
        renderChatHistory();
      }
    }

    function saveChatHistory() {
      if (settings.saveHistory) {
        localStorage.setItem('joesai_chat_history', JSON.stringify(chatHistory));
      }
      if (currentUser) {
        saveUserData();
      }
    }

    function addMessageToHistory(role, content) {
      chatHistory.push({ role, content, timestamp: Date.now() });
      saveChatHistory();
    }

    function renderChatHistory() {
      // Keep welcome message, clear others
      chatMessages.innerHTML = '';
      
      if (chatHistory.length === 0) {
        renderWelcomeMessage();
        return;
      }
      
      chatHistory.forEach(msg => {
        addMessageToUI(msg.role, msg.content, false);
      });
    }

    function renderWelcomeMessage() {
      const showLoginPrompt = !currentUser;
      chatMessages.innerHTML = `
        <div class="flex justify-center py-8">
          <div class="text-center">
            <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
            </div>
            <h3 class="text-white text-xl font-bold mb-2">Welcome to JoeSai!</h3>
            <p class="text-purple-300">Your intelligent AI assistant powered by Groq API</p>
            ${showLoginPrompt ? '<p class="text-white/60 text-sm mt-4">Please login or sign up to save your chat history</p>' : ''}
          </div>
        </div>
      `;
    }

    function addMessageToUI(role, content, animate = true) {
      const messageDiv = document.createElement('div');
      messageDiv.className = animate ? 'message-enter' : '';
      
      if (role === 'user') {
        messageDiv.className += ' flex justify-end';
        messageDiv.innerHTML = `
          <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-2xl py-2 px-4 max-w-[80%]">
            ${escapeHtml(content)}
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="flex items-start space-x-2">
            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
            </div>
            <div class="bg-white/10 backdrop-blur-sm text-white rounded-2xl py-2 px-4 max-w-[80%] prose prose-invert">
              ${formatResponse(content)}
            </div>
          </div>
        `;
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
      // Check if Firebase is initialized
      if (!auth || !db) {
        alert('Authentication not available. Please refresh the page.');
        return;
      }
      
      // Check if Groq API key is configured
      if (!GROQ_API_KEY) {
        alert('Groq API key not configured. Please set VITE_GROQ_API_KEY in your .env file and rebuild.');
        return;
      }
      
      const message = messageInput.value.trim();
      if (!message) return;
      
      messageInput.value = '';
      addMessageToUI('user', message);
      addMessageToHistory('user', message);
      
      // Show typing indicator
      if (settings.showTyping) {
        showTypingIndicator();
      }
      
      try {
        // Check API response
        const response = await fetch(GROQ_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${GROQ_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'llama-3.1-8b-instant',
            messages: [
              { role: 'system', content: AI_CONTEXT },
              ...chatHistory.slice(-10).map(msg => ({ role: msg.role, content: msg.content })),
              { role: 'user', content: message }
            ],
            temperature: settings.creativity,
            max_tokens: settings.maxTokens,
            top_p: 0.9,
            stream: false
          })
        });
        
        removeTypingIndicator();
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message || 'API returned an error');
        }
        
        const aiResponse = data.choices[0]?.message?.content || 'I apologize, but I could not generate a response. Please try again.';
        
        addMessageToUI('assistant', aiResponse);
        addMessageToHistory('assistant', aiResponse);
        
      } catch (error) {
        console.error('Chat error:', error);
        removeTypingIndicator();
        
        let errorMessage = 'Sorry, I encountered an error. Please check your internet connection and try again.';
        if (error.message.includes('API Error')) {
          errorMessage = 'AI service is temporarily unavailable. Please try again later.';
        }
        
        addMessageToUI('assistant', errorMessage);
      }
    }

    function showTypingIndicator() {
      const indicator = document.createElement('div');
      indicator.id = 'typing-indicator';
      indicator.className = 'message-enter flex items-start space-x-2';
      indicator.innerHTML = `
        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
        </div>
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl py-3 px-4">
          <div class="typing-indicator flex space-x-1">
            <span class="w-2 h-2 bg-purple-400 rounded-full"></span>
            <span class="w-2 h-2 bg-purple-400 rounded-full"></span>
            <span class="w-2 h-2 bg-purple-400 rounded-full"></span>
          </div>
        </div>
      `;
      chatMessages.appendChild(indicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) indicator.remove();
    }

    function clearChat() {
      if (confirm('Are you sure you want to clear all chat history?')) {
        chatHistory = [];
        saveChatHistory();
        renderWelcomeMessage();
      }
    }

    // Modal Functions
    window.openLoginModal = function() {
      document.getElementById('login-modal').classList.remove('hidden');
    };
    
    window.closeLoginModal = function() {
      document.getElementById('login-modal').classList.add('hidden');
    };
    
    window.openRegisterModal = function() {
      document.getElementById('register-modal').classList.remove('hidden');
    };
    
    window.closeRegisterModal = function() {
      document.getElementById('register-modal').classList.add('hidden');
    };
    
    window.switchToRegister = function() {
      closeLoginModal();
      openRegisterModal();
    };
    
    window.switchToLogin = function() {
      closeRegisterModal();
      openLoginModal();
    };
    
    window.openSettingsModal = function() {
      if (!currentUser) {
        alert('Please login to access settings');
        return;
      }
      
      document.getElementById('settings-avatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || 'User')}&background=7c3aed&color=fff`;
      document.getElementById('settings-name').textContent = currentUser.displayName || 'User';
      document.getElementById('settings-email').textContent = currentUser.email || '';
      
      document.getElementById('settings-modal').classList.remove('hidden');
    };
    
    window.closeSettingsModal = function() {
      document.getElementById('settings-modal').classList.add('hidden');
    };

    // Upgrade Modal Functions
    window.openUpgradeModal = function() {
      if (!currentUser) {
        alert('Please login to upgrade');
        return;
      }
      document.getElementById('upgrade-modal').classList.remove('hidden');
    };
    
    window.closeUpgradeModal = function() {
      document.getElementById('upgrade-modal').classList.add('hidden');
    };

    // Admin Modal Functions
    window.openAdminModal = function() {
      document.getElementById('admin-modal').classList.remove('hidden');
      loadAdminRequests('pending');
    };
    
    window.closeAdminModal = function() {
      document.getElementById('admin-modal').classList.add('hidden');
    };

    window.switchAdminTab = function(tab) {
      // Update tab buttons
      document.getElementById('admin-pending-tab').className = tab === 'pending' ? 'px-4 py-2 bg-purple-600 text-white rounded-lg' : 'px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600';
      document.getElementById('admin-approved-tab').className = tab === 'approved' ? 'px-4 py-2 bg-purple-600 text-white rounded-lg' : 'px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600';
      document.getElementById('admin-rejected-tab').className = tab === 'rejected' ? 'px-4 py-2 bg-purple-600 text-white rounded-lg' : 'px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600';
      
      // Show/hide content
      document.getElementById('admin-pending-content').classList.toggle('hidden', tab !== 'pending');
      document.getElementById('admin-approved-content').classList.toggle('hidden', tab !== 'approved');
      document.getElementById('admin-rejected-content').classList.toggle('hidden', tab !== 'rejected');
      
      loadAdminRequests(tab);
    };

    // Privacy & Terms Modal Functions
    window.openPrivacyModal = function() {
      document.getElementById('privacy-modal').classList.remove('hidden');
    };
    
    window.closePrivacyModal = function() {
      document.getElementById('privacy-modal').classList.add('hidden');
    };
    
    window.openTermsModal = function() {
      document.getElementById('terms-modal').classList.remove('hidden');
    };
    
    window.closeTermsModal = function() {
      document.getElementById('terms-modal').classList.add('hidden');
    };

    // Data Management
    function exportChatHistory() {
      const dataStr = JSON.stringify(chatHistory, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `joesai-chat-history-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function deleteAllHistory() {
      if (confirm('Are you sure you want to delete all chat history? This cannot be undone.')) {
        chatHistory = [];
        saveChatHistory();
        renderWelcomeMessage();
        alert('Chat history deleted successfully');
      }
    }

    async function deleteAccount() {
      if (!currentUser) return;
      
      if (confirm('Are you sure you want to delete your account? This action cannot be undone and all your data will be permanently deleted.')) {
        try {
          // Delete user data from Firestore
          await deleteDoc(doc(db, 'users', currentUser.uid));
          
          // Delete authentication account
          await currentUser.delete();
          
          alert('Account deleted successfully');
          closeSettingsModal();
        } catch (error) {
          console.error('Error deleting account:', error);
          alert('Error deleting account. You may need to re-authenticate.');
        }
      }
    }

    // Upgrade Functions
    async function handleUpgradeSubmit(e) {
      e.preventDefault();
      
      const transactionId = document.getElementById('upgrade-transaction-id').value.trim();
      const phone = document.getElementById('upgrade-phone').value.trim();
      
      if (!transactionId || !phone) {
        alert('Please fill in all fields');
        return;
      }
      
      try {
        // Save upgrade request to Firestore
        await addDoc(collection(db, 'upgrade_requests'), {
          userId: currentUser.uid,
          userEmail: currentUser.email,
          userName: currentUser.displayName || currentUser.email,
          transactionId: transactionId,
          phone: phone,
          amount: 10000,
          status: 'pending',
          createdAt: new Date()
        });
        
        alert('Your upgrade request has been submitted! We will review it shortly.');
        closeUpgradeModal();
        document.getElementById('upgrade-form').reset();
      } catch (error) {
        console.error('Error submitting upgrade:', error);
        alert('Error submitting upgrade request. Please try again.');
      }
    }

    // Admin Functions
    function loadAdminRequests(status) {
      const listId = status + '-requests-list';
      const listElement = document.getElementById(listId);
      
      listElement.innerHTML = '<p class="text-gray-400 text-center py-8">Loading...</p>';
      
      // Load requests from Firestore
      getDocs(query(collection(db, 'upgrade_requests'), where('status', '==', status)))
        .then(snapshot => {
          if (snapshot.empty) {
            listElement.innerHTML = `<p class="text-gray-400 text-center py-8">No ${status} requests</p>`;
            return;
          }
          
          let html = '';
          snapshot.forEach(doc => {
            const request = doc.data();
            html += `
              <div class="bg-gray-800 rounded-xl p-4">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <p class="text-white font-medium">${escapeHtml(request.userName || 'Unknown')}</p>
                    <p class="text-gray-400 text-sm">${escapeHtml(request.userEmail || '')}</p>
                  </div>
                  <span class="px-2 py-1 rounded text-xs font-medium ${status === 'pending' ? 'bg-yellow-600' : status === 'approved' ? 'bg-green-600' : 'bg-red-600'}">
                    ${status.charAt(0).toUpperCase() + status.slice(1)}
                  </span>
                </div>
                <div class="text-sm text-gray-300 space-y-1 mb-3">
                  <p>Transaction ID: <span class="font-mono text-purple-400">${escapeHtml(request.transactionId || '')}</span></p>
                  <p>Phone: ${escapeHtml(request.phone || '')}</p>
                  <p>Amount: UGX ${request.amount || 10000}</p>
                  <p>Date: ${request.createdAt ? new Date(request.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</p>
                </div>
                ${status === 'pending' ? `
                  <div class="flex space-x-2">
                    <button onclick="approveRequest('${doc.id}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors">
                      âœ“ Approve
                    </button>
                    <button onclick="rejectRequest('${doc.id}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-colors">
                      âœ— Reject
                    </button>
                  </div>
                ` : ''}
              </div>
            `;
          });
          listElement.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading requests:', error);
          listElement.innerHTML = '<p class="text-red-400 text-center py-8">Error loading requests</p>';
        });
    }

    window.approveRequest = async function(requestId) {
      try {
        await updateDoc(doc(db, 'upgrade_requests', requestId), {
          status: 'approved',
          processedAt: new Date(),
          processedBy: currentUser.email
        });
        
        // Get the request to find the user
        const requestDoc = await getDoc(doc(db, 'upgrade_requests', requestId));
        const requestData = requestDoc.data();
        
        // Update user's premium status
        if (requestData && requestData.userId) {
          await updateDoc(doc(db, 'users', requestData.userId), {
            isPremium: true,
            premiumApprovedAt: new Date()
          });
        }
        
        alert('Request approved successfully!');
        loadAdminRequests('pending');
      } catch (error) {
        console.error('Error approving request:', error);
        alert('Error approving request. Please try again.');
      }
    };

    window.rejectRequest = async function(requestId) {
      try {
        await updateDoc(doc(db, 'upgrade_requests', requestId), {
          status: 'rejected',
          processedAt: new Date(),
          processedBy: currentUser.email
        });
        
        alert('Request rejected');
        loadAdminRequests('pending');
      } catch (error) {
        console.error('Error rejecting request:', error);
        alert('Error rejecting request. Please try again.');
      }
    };

    // Utility Functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatResponse(text) {
      // Handle code blocks first (triple backticks)
      let formatted = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
        return `<pre class="bg-gray-900 rounded-lg p-4 my-3 overflow-x-auto"><code class="text-green-400 font-mono text-sm">${escapeHtml(code.trim())}</code></pre>`;
      });
      
      // Handle inline code
      formatted = formatted.replace(/`(.*?)`/g, '<code class="bg-gray-800 px-2 py-1 rounded text-pink-400 font-mono text-sm">$1</code>');
      
      // Handle bold and italic
      formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-bold">$1</strong>');
      formatted = formatted.replace(/\*(.*?)\*/g, '<em class="text-purple-300">$1</em>');
      
      // Handle line breaks
      formatted = formatted.replace(/\n/g, '<br>');
      
      return formatted;
    }

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });
  </script>

    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeUpgradeModal()"></div>
      <div class="relative flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
          <button onclick="closeUpgradeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Upgrade to Premium</h2>
            <p class="text-gray-400">Unlock full access to JoeSai AI</p>
          </div>
          
          <div class="bg-yellow-900/30 border border-yellow-700 rounded-xl p-4 mb-6">
            <h3 class="text-yellow-400 font-semibold mb-2">Payment Details</h3>
            <p class="text-white mb-1">Amount: <span class="font-bold text-yellow-400">UGX 10,000</span></p>
            <p class="text-white mb-1">Mobile Money to: <span class="font-bold">+256756454646</span></p>
            <p class="text-white">Account Name: <span class="font-bold">KAIGWA AKRAM</span></p>
          </div>
          
          <form id="upgrade-form" class="space-y-4">
            <div>
              <label class="block text-gray-300 text-sm font-medium mb-2">Transaction ID / Reference</label>
              <input type="text" id="upgrade-transaction-id" required placeholder="Enter your payment transaction ID" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-yellow-500">
            </div>
            <div>
              <label class="block text-gray-300 text-sm font-medium mb-2">Phone Number Used</label>
              <input type="tel" id="upgrade-phone" required placeholder="e.g., +2567xxxxxxx" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-yellow-500">
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-3 rounded-xl transition-all">
              Submit Payment
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div id="admin-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAdminModal()"></div>
      <div class="relative flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto">
          <button onclick="closeAdminModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-pink-500 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
              </svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-white">Admin Dashboard</h2>
              <p class="text-gray-400">Manage user upgrades</p>
            </div>
          </div>
          
          <!-- Tabs -->
          <div class="flex space-x-2 mb-4">
            <button id="admin-pending-tab" class="px-4 py-2 bg-purple-600 text-white rounded-lg" onclick="switchAdminTab('pending')">
              Pending Requests
            </button>
            <button id="admin-approved-tab" class="px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600" onclick="switchAdminTab('approved')">
              Approved
            </button>
            <button id="admin-rejected-tab" class="px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600" onclick="switchAdminTab('rejected')">
              Rejected
            </button>
          </div>
          
          <!-- Pending Requests -->
          <div id="admin-pending-content">
            <div id="pending-requests-list" class="space-y-3">
              <p class="text-gray-400 text-center py-8">Loading pending requests...</p>
            </div>
          </div>
          
          <!-- Approved Requests -->
          <div id="admin-approved-content" class="hidden">
            <div id="approved-requests-list" class="space-y-3">
              <p class="text-gray-400 text-center py-8">No approved requests</p>
            </div>
          </div>
          
          <!-- Rejected Requests -->
          <div id="admin-rejected-content" class="hidden">
            <div id="rejected-requests-list" class="space-y-3">
              <p class="text-gray-400 text-center py-8">No rejected requests</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closePrivacyModal()"></div>
      <div class="relative flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
          <button onclick="closePrivacyModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <h2 class="text-2xl font-bold text-white mb-6">Privacy Policy</h2>
          
          <div class="prose prose-invert text-gray-300 space-y-4">
            <p><strong>Last Updated:</strong> February 2026</p>
            
            <h3 class="text-white font-semibold">1. Information We Collect</h3>
            <p>We collect information you provide directly to us, including:
            <ul class="list-disc pl-5 space-y-1">
              <li>Account information (name, email) when you sign up</li>
              <li>Chat history and conversations with JoeSai</li>
              <li>Payment information for premium upgrades</li>
            </ul></p>
            
            <h3 class="text-white font-semibold">2. How We Use Your Information</h3>
            <p>We use the information we collect to:
            <ul class="list-disc pl-5 space-y-1">
              <li>Provide and maintain our AI services</li>
              <li>Process your payments and upgrades</li>
              <li>Improve and personalize your experience</li>
              <li>Send you important updates and notifications</li>
            </ul></p>
            
            <h3 class="text-white font-semibold">3. Data Storage</h3>
            <p>Your chat history is stored securely. You can request deletion of your data at any time through the Settings menu.</p>
            
            <h3 class="text-white font-semibold">4. Third-Party Services</h3>
            <p>We use Firebase (Google) for authentication and Firestore for data storage. Both services comply with industry security standards.</p>
            
            <h3 class="text-white font-semibold">5. Contact Us</h3>
            <p>If you have any questions about this Privacy Policy, please contact us through the app.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="terms-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeTermsModal()"></div>
      <div class="relative flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
          <button onclick="closeTermsModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <h2 class="text-2xl font-bold text-white mb-6">Terms of Service</h2>
          
          <div class="prose prose-invert text-gray-300 space-y-4">
            <p><strong>Last Updated:</strong> February 2026</p>
            
            <h3 class="text-white font-semibold">1. Acceptance of Terms</h3>
            <p>By accessing and using JoeSai, you accept and agree to be bound by the terms and provision of this agreement.</p>
            
            <h3 class="text-white font-semibold">2. Use License</h3>
            <p>JoeSai grants you a limited, non-exclusive, non-transferable license to use our AI assistant for personal and educational purposes.</p>
            
            <h3 class="text-white font-semibold">3. Premium Services</h3>
            <p>Premium features require payment. All payments are final and non-refundable unless otherwise specified.</p>
            
            <h3 class="text-white font-semibold">4. User Responsibilities</h3>
            <p>You agree to:
            <ul class="list-disc pl-5 space-y-1">
              <li>Provide accurate information</li>
              <li>Not use the service for illegal purposes</li>
              <li>Not attempt to hack or reverse engineer the service</li>
              <li>Respect other users and the AI assistant</li>
            </ul></p>
            
            <h3 class="text-white font-semibold">5. Disclaimer</h3>
            <p>JoeSai is an AI assistant. Responses are generated by AI and may not always be accurate. Users should verify important information independently.</p>
            
            <h3 class="text-white font-semibold">6. Limitation of Liability</h3>
            <p>JoeSai shall not be liable for any indirect, incidental, special, or consequential damages arising from the use of the service.</p>
            
            <h3 class="text-white font-semibold">7. Changes to Terms</h3>
            <p>We reserve the right to modify these terms at any time. Continued use of the service constitutes acceptance of modified terms.</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
